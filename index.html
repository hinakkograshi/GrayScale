<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ ç·šã¨å½± */
        #originalCanvas,
        #processedCanvas {
            border: 1px solid #ddd;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 100%;
            height: auto;
            background-color: #fff;
        }

        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-primary {
            transition: all 0.2s;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="p-8">

    <div class="max-w-6xl mx-auto space-y-8">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-6">
            ç”»åƒå‡¦ç†ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒ‡ãƒ¢
        </h1>
        <p class="text-center text-gray-600">
            ç”»åƒã‚’é¸æŠã—ã€ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†ã®å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚
        </p>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div
            class="bg-white p-6 rounded-xl shadow-lg flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">

            <!-- ç”»åƒé¸æŠ -->
            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageSelection(event)">
            <button onclick="document.getElementById('imageInput').click()"
                class="btn-primary px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600">
                ç”»åƒã‚’é¸æŠ
            </button>

            <!-- å‡¦ç†å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
            <button id="processButton" onclick="processImage('js')" disabled
                class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 disabled:bg-gray-400">
                ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ– (JavaScript)
            </button>
            <button id="processButtonWasm" onclick="processImage('wasm')" disabled
                class="px-6 py-3 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 disabled:bg-gray-400">
                ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ– (SwiftWasm)
            </button>
        </div>

        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">å‡¦ç†çµæœ</h2>
            <div id="statusMessage" class="text-lg font-medium text-blue-700">ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</div>
            <div id="timeResult" class="text-xl font-bold mt-2 text-red-600"></div>
        </div>

        <!-- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒ</h2>
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">å‡¦ç†æ¸ˆã¿ç”»åƒ</h2>
                <canvas id="processedCanvas"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        import { init } from "./.build/plugins/PackageToJS/outputs/Package/index.js";
        await init();

        // DOMè¦ç´ ã®å–å¾—
        const originalCanvas = document.getElementById('originalCanvas');
        const processedCanvas = document.getElementById('processedCanvas');
        const processButton = document.getElementById('processButton');
        const processButtonWasm = document.getElementById('processButtonWasm');
        const statusMessage = document.getElementById('statusMessage');
        const timeResult = document.getElementById('timeResult');

        let originalImage; // ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸImageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ

        // --- 1. ç”»åƒé¸æŠã¨è¡¨ç¤º ---
        globalThis.handleImageSelection = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            statusMessage.textContent = 'ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...';
            timeResult.textContent = '';

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    originalImage = img;

                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã‚‹
                    const size = Math.min(img.width, img.height, 512); // æœ€å¤§ã‚µã‚¤ã‚ºã‚’512x512ã«åˆ¶é™
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    processedCanvas.width = img.width;
                    processedCanvas.height = img.height;

                    // ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç”»åƒã‚’æç”»
                    const ctx = originalCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, img.width, img.height);

                    // å‡¦ç†å¾Œã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
                    processedCanvas.getContext('2d').clearRect(0, 0, img.width, img.height);

                    statusMessage.textContent = `ç”»åƒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚ã‚µã‚¤ã‚º: ${img.width} x ${img.height}`;
                    processButton.disabled = false;
                    processButtonWasm.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- 2. ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†ã®å®Ÿè¡Œï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–JavaScriptï¼‰ ---
        globalThis.processImage = async function(mode) {
            if (!originalImage) {
                statusMessage.textContent = 'å…ˆã«ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            statusMessage.textContent = 'ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†ã‚’å®Ÿè¡Œä¸­...';
            timeResult.textContent = '';
            processButton.disabled = true;
            processButtonWasm.disabled = true;

            const width = originalCanvas.width;
            const height = originalCanvas.height;
            const ctx = originalCanvas.getContext('2d');

            // ã‚ªãƒªã‚¸ãƒŠãƒ«ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let imageData = ctx.getImageData(0, 0, width, height);
            let data = imageData.data;
            const length = data.length;

            if (mode === 'wasm') {
                // warmup
                convertBySwift(imageData.data);
            }

            // --- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬é–‹å§‹ ---
            const startTime = performance.now();

            // ----------------------------------------------------
            // ğŸ’¡ ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (JavaScriptç‰ˆ)
            // ----------------------------------------------------
            statusMessage.textContent = `${mode === 'js' ? 'JavaScript' : 'SwiftWasm'} å‡¦ç†ã‚’å®Ÿè¡Œä¸­...`;

            let processedData;

            if (mode === 'js') {
                processedData = jsGrayscale(imageData.data, imageData.data.length);

            } else if (mode === 'wasm') {

                processedData = convertBySwift(imageData.data);
            }

            function jsGrayscale(data, length) {
                // å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨ (å…ƒã®é…åˆ—ã®ã‚³ãƒ”ãƒ¼)
                const processedData = Uint8ClampedArray.from(data.slice());

                // RGBAãƒ‡ãƒ¼ã‚¿ï¼ˆ4ãƒã‚¤ãƒˆ/ãƒ”ã‚¯ã‚»ãƒ«ï¼‰ã«å¯¾ã—ã¦åå¾©å‡¦ç†
                for (let i = 0; i < length; i += 4) {
                    const r = processedData[i];
                    const g = processedData[i + 1];
                    const b = processedData[i + 2];

                    // è¼åº¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
                    const grayValue = 0.299 * r + 0.587 * g + 0.114 * b;

                    // R, G, B ã®å€¤ã‚’è¼åº¦å€¤ã§ç½®ãæ›ãˆã‚‹
                    processedData[i] = grayValue;     // R
                    processedData[i + 1] = grayValue; // G
                    processedData[i + 2] = grayValue; // B
                }
                return processedData;
            }

            // --- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬çµ‚äº† ---
            const endTime = performance.now();
            const timeMs = (endTime - startTime).toFixed(2);         

            // å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            let finalImageData = ctx.createImageData(width, height);
            finalImageData.data.set(processedData);
            processedCanvas.getContext('2d').putImageData(finalImageData, 0, 0);

            const modeName = mode === 'js' ? 'JavaScript' : 'SwiftWasm';

            // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°
            statusMessage.textContent = 'ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            timeResult.textContent = `${timeMs} ãƒŸãƒªç§’`;
            processButton.disabled = false;
            processButtonWasm.disabled = false;
        }
    </script>
</body>

</html>